<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Collection Master PRO (å®Œå…¨ç‰ˆã‚µã‚¯ã‚µã‚¯)</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root { --primary: #2c3e50; --accent: #3498db; --success: #27ae60; --error: #e74c3c; --bg: #f4f7f6; }
body { font-family: sans-serif; background: var(--bg); padding: 20px; color: #333; margin: 0; }
.container { max-width: 1100px; margin: auto; background: white; padding: 25px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.1); }
.dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
.card { background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 15px; }
.chart-container { height: 220px; position: relative; }
.form-section { background: #edf2f7; padding: 20px; border-radius: 15px; margin-bottom: 30px; }
.form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
input, select { padding: 12px; border: 1px solid #cbd5e0; border-radius: 8px; width: 100%; box-sizing: border-box; font-size: 16px; }
.status-msg { margin: 15px 0; padding: 15px; border-radius: 10px; font-weight: bold; text-align: center; display: none; line-height: 1.6; }
.msg-found { background: #e8f4fd; color: #2980b9; border: 1px solid #3498db; }
.msg-notfound { background: #e9f7ef; color: #27ae60; border: 1px solid #2ecc71; }
.msg-manual { background: #fff3e0; color: #e67e22; border: 1px solid #f39c12; }
.item-card { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; background: #fff; }
.item-img { width: 70px; height: 70px; object-fit: cover; border-radius: 6px; margin-right: 15px; background: #eee; border: 1px solid #ddd; }
.item-main { flex-grow: 1; }
.tag { font-size: 0.7em; padding: 3px 8px; border-radius: 4px; color: white; margin-right: 5px; font-weight: bold; }
.btn { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
.btn-primary { background: var(--accent); color: white; }
.btn-success { background: var(--success); color: white; width: 100%; margin-top: 15px; font-size: 1.1em; }
.btn-success:disabled { background: #bdc3c7; cursor: wait; }
.btn-ghost { background: #e2e8f0; color: #4a5568; font-size: 0.85em; }
.btn-delete { color: var(--error); padding: 5px 10px; font-size: 1.2em; }
.sync-status { text-align: right; font-size: 0.8em; color: #666; margin-bottom: 5px; }
@media (max-width: 600px) { .item-card { flex-direction: column; text-align: center; } .item-img { margin-right: 0; margin-bottom: 10px; } }
</style>
</head>
<body>
<div class="container">
<header style="text-align:center; margin-bottom:20px;">
<h1 style="color:var(--primary); margin:0;">Collection Master Cloud</h1>
<p style="color:#666;">2026å¹´ãƒ»ã‚´ãƒŸç®± ï¼† é€£ç¶šã‚¬ãƒ¼ãƒ‰ å®Œå…¨ç‰ˆ</p>
</header>

<div id="sync-status" class="sync-status">åŒæœŸä¸­...</div>

<div class="dashboard">
<div class="card"><div class="chart-container"><canvas id="pieChart"></canvas></div></div>
<div class="card"><div class="chart-container"><canvas id="lineChart"></canvas></div></div>
</div>

<div class="form-section">
<div style="display: flex; gap: 10px; margin-bottom: 15px;">
<input type="text" id="api-input" placeholder="ISBN ã¾ãŸã¯ ãƒ¬ã‚³ãƒ¼ãƒ‰å“ç•ªã‚’å…¥åŠ›...">
<button class="btn btn-primary" id="search-btn" onclick="searchWorkflow()">åˆ¤å®šãƒ»å–å¾—</button>
</div>
<div id="result-message" class="status-msg"></div>
<div id="registration-form" style="display: none;">
<div class="form-grid">
<select id="type">
<option value="book">ğŸ“š æœ¬</option>
<option value="cd">ğŸ’¿ CD</option>
<option value="record" selected>ğŸ¸ ãƒ¬ã‚³ãƒ¼ãƒ‰</option>
<option value="other">ğŸ“¦ ãã®ä»–</option>
</select>
<input type="text" id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆï¼‰">
<input type="text" id="creator" placeholder="ä½œè€… / ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ">
<input type="text" id="code-display" placeholder="è­˜åˆ¥ã‚³ãƒ¼ãƒ‰">
<input type="number" id="price" placeholder="ä¾¡æ ¼ï¼ˆå††ï¼‰">
<input type="text" id="shop" placeholder="è³¼å…¥åº—èˆ—">
<input type="text" id="location" placeholder="ä¿ç®¡å ´æ‰€">
<select id="condition">
<option value="æ–°å“">æ–°å“</option>
<option value="ä¸­å¤">ä¸­å¤</option>
<option value="æœªé–‹å°">æœªé–‹å°</option>
</select>
<input type="date" id="date">
<input type="hidden" id="edit-index" value="-1"><input type="hidden" id="img-url">
</div>
<button id="main-save-btn" class="btn btn-success" onclick="saveItem()">ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¦åŒæœŸ</button>
</div>
</div>

<div style="background:#fff; padding:15px; border-radius:12px; margin-bottom:20px; border:1px solid #eee;">
<input type="text" id="search" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ãƒ»å“ç•ªãƒ»ä½œè€…ã§æ¤œç´¢..." style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px; border:1px solid #ddd;" oninput="render(true)">
<div style="display:flex; flex-wrap:wrap; gap:8px;">
<button class="btn btn-ghost" onclick="sortData('date', 'desc')">ğŸ“… æ–°ç€é †</button>
<button class="btn btn-ghost" onclick="sortData('title', 'asc')">ğŸ”¤ åå‰é †</button>
</div>
</div>

<div id="list" style="border-radius:15px; overflow: hidden; border: 1px solid #eee;"></div>
<div id="load-more-container" class="load-more-area" style="display:none; text-align:center; padding:20px;">
<button class="btn btn-ghost" onclick="displayLimit += 50; render();">ã•ã‚‰ã«è¡¨ç¤ºã™ã‚‹</button>
</div>
</div>

<script>
const GAS_URL = "https://script.google.com/macros/s/AKfycbz9Io-YZwOWxwzotMvkHYYTPHUosJ_ZQIEP8Nqze1taq2XwxZY5tPaGZ-iL_z92hGhTeA/exec";
let items = [], displayLimit = 30, pieChart = null;

async function loadData() {
try {
const res = await fetch(GAS_URL);
items = await res.json();
document.getElementById('sync-status').innerText = "âœ… åŒæœŸæ¸ˆã¿ (" + items.length + "ä»¶)";
render();
} catch(e){ document.getElementById('sync-status').innerText = "âŒ åŒæœŸã‚¨ãƒ©ãƒ¼"; }
}

async function searchWorkflow() {
const input = document.getElementById('api-input').value.trim();
if(!input) return;
const cleanInput = input.replace(/[^a-z0-9]/gi,'').toLowerCase();
const msgArea = document.getElementById('result-message');
const formArea = document.getElementById('registration-form');
const duplicate = items.find(i => (i.code||'').toString().replace(/[^a-z0-9]/gi,'').toLowerCase()===cleanInput && cleanInput!=='');
if(duplicate){
msgArea.className="status-msg msg-found";
msgArea.innerHTML=`âš ï¸ ç™»éŒ²æ¸ˆã¿ï¼šã€Œ${duplicate.title}ã€<br>è¿½åŠ ã§ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ`;
}
const foundOnline = await autoFetch(input);
if(!duplicate){
if(foundOnline){
msgArea.className="status-msg msg-notfound";
msgArea.innerText="ğŸ” ãƒãƒƒãƒˆæƒ…å ±ã‚’å–å¾—ã—ã¾ã—ãŸã€‚ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ";
}else{
msgArea.className="status-msg msg-manual";
msgArea.innerText="â“ æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¾ã™ã‹ï¼Ÿ";
}}
msgArea.style.display="block";
formArea.style.display="block";
document.getElementById('edit-index').value="-1";
document.getElementById('main-save-btn').innerText="ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã—ã¦ä¿å­˜";
formArea.scrollIntoView({behavior:'smooth',block:'center'});
}

async function autoFetch(input){
document.getElementById('code-display').value=input;
const cleanInput=input.replace(/-/g,'');
const type=document.getElementById('type').value;
let success=false;
try{
if(type==='book'){
const res=await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${cleanInput}`);
const data=await res.json();
if(data.totalItems>0){
const info=data.items[0].volumeInfo;
document.getElementById('title').value=info.title||'';
document.getElementById('creator').value=info.authors?info.authors.join(', '):'';
document.getElementById('img-url').value=info.imageLinks?info.imageLinks.thumbnail:'';
success=true;
}
}else{
const res=await fetch(`https://musicbrainz.org/ws/2/release/?query=barcode:${cleanInput}%20OR%20catno:${input}&fmt=json`);
const data=await res.json();
if(data.releases && data.releases.length>0){
const info=data.releases[0];
document.getElementById('title').value=info.title||'';
document.getElementById('creator').value=info['artist-credit']?info['artist-credit'][0].name:'';
success=true;
}
}
}catch(e){console.error(e);}
return success;
}

async function saveItem(){
const title=document.getElementById('title').value.trim();
if(!title) return alert("ã‚¿ã‚¤ãƒˆãƒ«å¿…é ˆ");
const saveBtn=document.getElementById('main-save-btn');
const searchBtn=document.getElementById('search-btn');
saveBtn.disabled=true; searchBtn.disabled=true;
saveBtn.innerText="â³ åŒæœŸä¸­...";
const item={
type:document.getElementById('type').value,
title:title,
creator:document.getElementById('creator').value.trim(),
code:document.getElementById('code-display').value.trim(),
price:parseInt(document.getElementById('price').value)||0,
shop:document.getElementById('shop').value||'',
location:document.getElementById('location').value||'',
condition:document.getElementById('condition').value,
date:document.getElementById('date').value||new Date().toISOString().split('T')[0],
img:document.getElementById('img-url').value||''
};
const index=parseInt(document.getElementById('edit-index').value);
const originalItems=[...items];
if(index===-1) items.unshift(item); else items[index]=item;
const isSuccess=await syncToCloud();
if(isSuccess){
resetForm();
document.getElementById('registration-form').style.display="none";
document.getElementById('result-message').style.display="none";
document.getElementById('api-input').value="";
render(true);
await loadData();
}else{ items=originalItems; alert("åŒæœŸå¤±æ•—ã€‚ã‚„ã‚Šç›´ã—ã¦ãã ã•ã„"); }
saveBtn.disabled=false; searchBtn.disabled=false;
saveBtn.innerText="ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜ã—ã¦åŒæœŸ";
}

async function syncToCloud(){
document.getElementById('sync-status').innerText="â³ ã‚µãƒ¼ãƒãƒ¼é€šä¿¡ä¸­...";
try{
await fetch(GAS_URL,{method:'POST',body:JSON.stringify(items)});
await new Promise(resolve=>setTimeout(resolve,1200));
document.getElementById('sync-status').innerText="âœ… åŒæœŸå®Œäº† ("+items.length+"ä»¶)";
return true;
}catch(e){ return false; }
}

function render(resetLimit=false){
if(resetLimit) displayLimit=30;
const list=document.getElementById('list');
const query=document.getElementById('search').value.toLowerCase();
const queryAlpha=query.replace(/[^a-z0-9]/gi,'');
list.innerHTML='';
let filteredCount=0, displayedCount=0;
const colors={book:'#3498db',cd:'#9b59b6',record:'#e67e22',other:'#95a5a6'};

items.map((item, originalIndex)=>({...item, originalIndex}))
.filter(item=>{
const codeAlpha=(item.code||'').toLowerCase().replace(/[^a-z0-9]/gi,'');
const targets=[item.title,item.creator,item.shop,item.location].join(' ').toLowerCase();
return targets.includes(query)||(queryAlpha!=='' && codeAlpha.includes(queryAlpha));
})
.forEach(item=>{
filteredCount++;
if(displayedCount<displayLimit){
displayedCount++;
const card=document.createElement('div');
card.className='item-card';
card.innerHTML=`
<img src="${item.img||'https://via.placeholder.com/100?text=No+Img'}" class="item-img">
<div class="item-main">
<span class="tag" style="background:${colors[item.type]}">${item.type}</span>
<div style="font-weight:bold;">${item.title}</div>
<div style="font-size:0.8em;color:#666;">ğŸ‘¤ ${item.creator} | ğŸ“ ${item.location}</div>
<div style="font-size:0.7em;color:#999;">ğŸ†” ${item.code||''}</div>
</div>
<div style="display:flex;gap:10px;">
<button class="btn btn-ghost" onclick="editItem(${item.originalIndex})">ğŸ“</button>
<button class="btn btn-ghost btn-delete" onclick="deleteItem(${item.originalIndex})">ğŸ—‘</button>
</div>`;
list.appendChild(card);
}
});
document.getElementById('load-more-container').style.display=(filteredCount>displayedCount)?'block':'none';
updateCharts();
}

function editItem(index){
const item=items[index];
document.getElementById('registration-form').style.display="block";
document.getElementById('result-message').style.display="none";
document.getElementById('type').value=item.type;
document.getElementById('title').value=item.title;
document.getElementById('creator').value=item.creator;
document.getElementById('code-display').value=item.code||'';
document.getElementById('price').value=item.price;
document.getElementById('shop').value=item.shop;
document.getElementById('location').value=item.location;
document.getElementById('condition').value=item.condition;
document.getElementById('date').value=item.date;
document.getElementById('img-url').value=item.img;
document.getElementById('edit-index').value=index;
window.scrollTo({top:0,behavior:'smooth'});
}

async function deleteItem(index){
if(confirm(`ã€Œ${items[index].title}ã€ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)){
items.splice(index,1);
const isSuccess=await syncToCloud();
if(isSuccess){ render(); alert("å‰Šé™¤ã—ã¾ã—ãŸ"); }else{ alert("åŒæœŸã‚¨ãƒ©ãƒ¼ã®ãŸã‚å‰Šé™¤ã§ãã¾ã›ã‚“ã§ã—ãŸ"); loadData(); }
}
}

function sortData(key,order){
items.sort((a,b)=>{
let vA=a[key]||'', vB=b[key]||'';
return order==='asc'?vA.toString().localeCompare(vB):vB.toString().localeCompare(vA);
});
render(true);
}

function resetForm(){
document.getElementById('edit-index').value="-1";
document.querySelectorAll('#registration-form input').forEach(i=>{ if(i.id!=='type') i.value=''; });
}

function updateCharts(){
let counts={book:0,cd:0,record:0,other:0};
items.forEach(item=>{ counts[item.type]++; });
const pieCtx=document.getElementById('pieChart').getContext('2d');
if(pieChart) pieChart.destroy();
pieChart=new Chart(pieCtx,{type:'doughnut',data:{labels:['æœ¬','CD','ãƒ¬ã‚³ãƒ¼ãƒ‰','ä»–'],datasets:[{data:[counts.book,counts.cd,counts.record,counts.other],backgroundColor:['#3498db','#9b59b6','#e67e22','#95a5a6']}]},options:{maintainAspectRatio:false}});
}

document.getElementById('date').value=new Date().toISOString().split('T')[0];
loadData();
</script>
</body>
</html>




