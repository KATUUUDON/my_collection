<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Collection Manager Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --bg: #f8f9fa;
        }

        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); }
        
        header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #eee; padding-bottom: 20px; }
        h1 { margin: 0; color: var(--primary); }

        /* „ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„ÉâÔºàÁµ±Ë®àÔºâ */
        .dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: #fff; border: 1px solid #eee; padding: 20px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; }
        .stat-info h4 { margin: 0; color: #7f8c8d; font-size: 0.9em; }
        .stat-info p { margin: 5px 0 0; font-size: 1.5em; font-weight: bold; }
        .chart-box { max-width: 200px; margin: auto; }

        /* „Éï„Ç©„Éº„É† */
        .add-section { background: #f1f4f7; padding: 20px; border-radius: 12px; margin-bottom: 30px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        input, select { padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; width: 100%; box-sizing: border-box; }
        .btn-row { margin-top: 15px; display: flex; gap: 10px; }
        button { padding: 12px 20px; border-radius: 8px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-save { background: var(--success); color: white; flex-grow: 1; }
        .btn-save:hover { opacity: 0.8; }
        
        /* Ê§úÁ¥¢„Å®„Éï„Ç£„É´„Çø */
        .controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 20px; align-items: center; }
        .search-box { flex-grow: 1; min-width: 250px; }
        .filter-btn { background: #ddd; color: #555; }
        .filter-btn.active { background: var(--primary); color: white; }

        /* „Ç¢„Ç§„ÉÜ„É†„É™„Çπ„Éà */
        .item-list { display: grid; gap: 15px; }
        .item-card { display: flex; align-items: center; background: white; border: 1px solid #eee; padding: 15px; border-radius: 12px; transition: 0.2s; }
        .item-card:hover { box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .item-img { width: 80px; height: 80px; border-radius: 8px; object-fit: cover; margin-right: 20px; background: #eee; }
        .item-info { flex-grow: 1; }
        .item-category { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.7em; text-transform: uppercase; margin-bottom: 5px; color: white; }
        .cat-book { background: #3498db; }
        .cat-cd { background: #9b59b6; }
        .cat-record { background: #e67e22; }
        .item-title { display: block; font-weight: bold; font-size: 1.1em; }
        .item-meta { color: #7f8c8d; font-size: 0.85em; }
        .item-price { font-weight: bold; color: var(--success); margin-left: 15px; font-size: 1.1em; }
        .actions { display: flex; gap: 5px; margin-left: 15px; }
        .btn-sm { padding: 6px 10px; font-size: 0.8em; }

        @media (max-width: 600px) {
            .item-card { flex-direction: column; text-align: center; }
            .item-img { margin: 0 0 10px 0; }
            .item-price { margin: 10px 0; }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <h1>My Collection</h1>
    </header>

    <div class="dashboard">
        <div class="stat-card">
            <div class="stat-info">
                <h4>Á∑èË≥áÁî£È°ç</h4>
                <p id="total-price">¬•0</p>
            </div>
            <div class="chart-box">
                <canvas id="typeChart"></canvas>
            </div>
        </div>
        <div class="stat-card">
            <div class="stat-info">
                <h4>„Ç¢„Ç§„ÉÜ„É†Êï∞</h4>
                <p id="total-count">0 items</p>
            </div>
        </div>
    </div>

    <div class="add-section">
        <h3 id="form-title">Êñ∞Ë¶èËøΩÂä†</h3>
        <div class="form-grid">
            <select id="type">
                <option value="book">Êú¨</option>
                <option value="cd">CD</option>
                <option value="record">„É¨„Ç≥„Éº„Éâ</option>
            </select>
            <input type="text" id="title" placeholder="„Çø„Ç§„Éà„É´ÔºàÂøÖÈ†àÔºâ">
            <input type="text" id="creator" placeholder="‰ΩúËÄÖ„Éª„Ç¢„Éº„ÉÜ„Ç£„Çπ„Éà">
            <input type="number" id="price" placeholder="‰æ°Ê†ºÔºàÂÜÜÔºâ">
            <input type="date" id="date">
            <input type="text" id="shop" placeholder="Ë≥ºÂÖ•Â∫ó">
            <input type="file" id="imgFile" accept="image/*">
            <input type="hidden" id="edit-index" value="-1">
        </div>
        <div class="btn-row">
            <button class="btn-save" onclick="saveItem()">‰øùÂ≠ò„Åô„Çã</button>
            <button id="cancel-btn" style="display:none;" onclick="resetForm()">„Ç≠„É£„É≥„Çª„É´</button>
        </div>
    </div>

    <div class="controls">
        <input type="text" class="search-box" id="search" placeholder="„Ç≠„Éº„ÉØ„Éº„Éâ„ÅßÊ§úÁ¥¢..." oninput="render()">
        <button class="filter-btn active" onclick="setFilter('all', this)">„Åô„Åπ„Å¶</button>
        <button class="filter-btn" onclick="setFilter('book', this)">Êú¨</button>
        <button class="filter-btn" onclick="setFilter('cd', this)">CD</button>
        <button class="filter-btn" onclick="setFilter('record', this)">„É¨„Ç≥„Éº„Éâ</button>
    </div>

    <div id="item-list" class="item-list"></div>
</div>

<script>
    let items = JSON.parse(localStorage.getItem('my_collection_v2')) || [];
    let currentFilter = 'all';
    let chartInstance = null;

    // ‰øùÂ≠òÂá¶ÁêÜ
    async function saveItem() {
        const title = document.getElementById('title').value;
        const index = parseInt(document.getElementById('edit-index').value);
        if (!title) return alert('„Çø„Ç§„Éà„É´„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ');

        const file = document.getElementById('imgFile').files[0];
        let imgBase64 = index >= 0 ? items[index].img : '';
        
        if (file) {
            imgBase64 = await toBase64(file);
        }

        const item = {
            type: document.getElementById('type').value,
            title: title,
            creator: document.getElementById('creator').value,
            price: parseInt(document.getElementById('price').value) || 0,
            date: document.getElementById('date').value || new Date().toISOString().split('T')[0],
            shop: document.getElementById('shop').value || '‰∏çÊòé',
            img: imgBase64
        };

        if (index === -1) items.push(item);
        else items[index] = item;

        localStorage.setItem('my_collection_v2', JSON.stringify(items));
        resetForm();
        render();
    }

    // ÁîªÂÉèÂ§âÊèõ
    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });

    function deleteItem(index) {
        if (confirm('ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü')) {
            items.splice(index, 1);
            localStorage.setItem('my_collection_v2', JSON.stringify(items));
            render();
        }
    }

    function editItem(index) {
        const item = items[index];
        document.getElementById('type').value = item.type;
        document.getElementById('title').value = item.title;
        document.getElementById('creator').value = item.creator;
        document.getElementById('price').value = item.price;
        document.getElementById('date').value = item.date;
        document.getElementById('shop').value = item.shop;
        document.getElementById('edit-index').value = index;
        document.getElementById('form-title').innerText = 'Á∑®ÈõÜ„É¢„Éº„Éâ';
        document.getElementById('cancel-btn').style.display = 'block';
        window.scrollTo(0,0);
    }

    function resetForm() {
        document.getElementById('edit-index').value = "-1";
        document.getElementById('form-title').innerText = 'Êñ∞Ë¶èËøΩÂä†';
        document.getElementById('cancel-btn').style.display = 'none';
        document.querySelectorAll('input').forEach(i => i.value = '');
        document.getElementById('date').value = new Date().toISOString().split('T')[0];
    }

    function setFilter(type, btn) {
        currentFilter = type;
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        render();
    }

    function render() {
        const list = document.getElementById('item-list');
        const searchTxt = document.getElementById('search').value.toLowerCase();
        list.innerHTML = '';

        let total = 0;
        let counts = { book: 0, cd: 0, record: 0 };

        const filtered = items.filter(item => {
            const matchFilter = currentFilter === 'all' || item.type === currentFilter;
            const matchSearch = item.title.toLowerCase().includes(searchTxt) || item.creator.toLowerCase().includes(searchTxt);
            return matchFilter && matchSearch;
        });

        filtered.forEach((item, index) => {
            total += item.price;
            counts[item.type]++;

            const card = document.createElement('div');
            card.className = 'item-card';
            card.innerHTML = `
                <img src="${item.img || 'https://via.placeholder.com/80'}" class="item-img">
                <div class="item-info">
                    <span class="item-category cat-${item.type}">${item.type}</span>
                    <span class="item-title">${item.title}</span>
                    <span class="item-meta">${item.creator} | ${item.shop} | ${item.date}</span>
                </div>
                <div class="item-price">¬•${item.price.toLocaleString()}</div>
                <div class="actions">
                    <button class="btn-sm" onclick="editItem(${index})">üìù</button>
                    <button class="btn-sm" style="background:#ff7675;color:white;" onclick="deleteItem(${index})">üóë</button>
                </div>
            `;
            list.appendChild(card);
        });

        document.getElementById('total-price').innerText = `¬•${total.toLocaleString()}`;
        document.getElementById('total-count').innerText = `${filtered.length} items`;
        updateChart(counts);
    }

    function updateChart(counts) {
        const ctx = document.getElementById('typeChart').getContext('2d');
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                datasets: [{
                    data: [counts.book, counts.cd, counts.record],
                    backgroundColor: ['#3498db', '#9b59b6', '#e67e22']
                }]
            },
            options: { cutout: '70%', plugins: { legend: { display: false } } }
        });
    }

    // ÂàùÂõûÂÆüË°å
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    render();
</script>

</body>
</html>

