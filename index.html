<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Collection Master PRO - Complete</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root { --primary:#2c3e50; --accent:#3498db; --success:#27ae60; --bg:#f4f7f6; }
body { margin:0; padding:20px; font-family:sans-serif; background:var(--bg); }
.container { max-width:1100px; margin:auto; background:#fff; padding:25px; border-radius:20px; box-shadow:0 10px 40px rgba(0,0,0,.1); }
.dashboard { display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px; margin-bottom:30px; }
.card { border:1px solid #eee; border-radius:15px; padding:15px; }
.chart-container { height:220px; }
.form-section { background:#edf2f7; padding:20px; border-radius:15px; margin-bottom:30px; }
.form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:12px; }
input,select { padding:10px; border-radius:6px; border:1px solid #cbd5e0; width:100%; }
.btn { padding:10px 18px; border-radius:8px; border:none; cursor:pointer; font-weight:bold; }
.btn-primary { background:var(--accent); color:#fff; }
.btn-success { background:var(--success); color:#fff; width:100%; margin-top:15px; }
.sync-status { text-align:right; font-size:.8em; color:#666; }
.item-card { display:flex; align-items:center; padding:15px; border-bottom:1px solid #eee; }
.item-img { width:70px; height:70px; object-fit:cover; border-radius:6px; margin-right:15px; background:#eee; }
.item-main { flex-grow:1; }
.tag { font-size:.7em; padding:3px 8px; border-radius:4px; color:#fff; font-weight:bold; }
@media(max-width:600px){
  .item-card{flex-direction:column;text-align:center;}
  .item-img{margin:0 0 10px;}
}
</style>
</head>

<body>
<div class="container">
<header style="text-align:center">
<h1>Collection Master Cloud</h1>
<p style="color:#666">å®Œå…¨å®‰å®šç‰ˆ</p>
</header>

<div id="sync-status" class="sync-status">åŒæœŸä¸­...</div>

<div class="dashboard">
  <div class="card"><div class="chart-container"><canvas id="pieChart"></canvas></div></div>
  <div class="card"><div class="chart-container"><canvas id="lineChart"></canvas></div></div>
</div>

<div class="form-section">
  <div style="display:flex;gap:10px;margin-bottom:15px;">
    <input id="api-input" placeholder="ISBN / ãƒãƒ¼ã‚³ãƒ¼ãƒ‰">
    <button class="btn btn-primary" onclick="autoFetch()">è‡ªå‹•å–å¾—</button>
  </div>

  <div class="form-grid">
    <select id="type">
      <option value="book">ğŸ“š æœ¬</option>
      <option value="cd">ğŸ’¿ CD</option>
      <option value="record">ğŸ¸ ãƒ¬ã‚³ãƒ¼ãƒ‰</option>
      <option value="other">ğŸ“¦ ãã®ä»–</option>
    </select>
    <input id="title" placeholder="ã‚¿ã‚¤ãƒˆãƒ«ï¼ˆå¿…é ˆï¼‰">
    <input id="creator" placeholder="ä½œè€… / ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ">
    <input id="code-display" placeholder="ISBN / å“ç•ª">
    <input id="price" type="number" placeholder="ä¾¡æ ¼">
    <input id="shop" placeholder="è³¼å…¥åº—">
    <input id="location" placeholder="ä¿ç®¡å ´æ‰€">
    <select id="condition"><option>æ–°å“</option><option>ä¸­å¤</option><option>æœªé–‹å°</option></select>
    <input id="date" type="date">
    <input type="hidden" id="edit-index" value="-1">
    <input type="hidden" id="img-url">
  </div>

  <button id="main-save-btn" class="btn btn-success" onclick="saveItem()">
    ãƒªã‚¹ãƒˆã«ä¿å­˜ã—ã¦ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸ
  </button>
</div>

<div id="list" style="border:1px solid #eee;border-radius:15px;overflow:hidden;"></div>
</div>

<script>
const GAS_URL = "YOUR_GAS_URL";

let items = [];
let pieChart=null, lineChart=null;

/* ---------- Cloud ---------- */
async function syncToCloud(){
  document.getElementById('sync-status').innerText="â³ ä¿å­˜ä¸­...";
  try{
    const res = await fetch(GAS_URL,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(items)
    });
    if(!res.ok) throw new Error();
    const r = await res.json();
    if(r.status!=="ok") throw new Error();
    document.getElementById('sync-status').innerText=`âœ… ä¿å­˜å®Œäº† (${items.length}ä»¶)`;
    return true;
  }catch{
    document.getElementById('sync-status').innerText="âŒ ä¿å­˜å¤±æ•—";
    alert("ã‚¯ãƒ©ã‚¦ãƒ‰ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\nå…¥åŠ›å†…å®¹ã¯ä¿æŒã•ã‚Œã¦ã„ã¾ã™ã€‚");
    return false;
  }
}

/* ---------- Fetch ---------- */
async function autoFetch(){
  const input=document.getElementById('api-input').value.trim();
  document.getElementById('code-display').value=input;
  const clean=input.replace(/-/g,'');
  try{
    if(document.getElementById('type').value==="book"){
      const r=await fetch(`https://www.googleapis.com/books/v1/volumes?q=isbn:${clean}`);
      const d=await r.json();
      if(d.items){
        const i=d.items[0].volumeInfo;
        title.value=i.title||"";
        creator.value=i.authors?.join(', ')||"";
        document.getElementById('img-url').value=i.imageLinks?.thumbnail||"";
      }
    }
  }catch{ alert("å–å¾—å¤±æ•—"); }
}

/* ---------- Save ---------- */
async function saveItem(){
  const titleVal=title.value.trim();
  if(!titleVal) return alert("ã‚¿ã‚¤ãƒˆãƒ«å¿…é ˆ");

  const item={
    type:type.value,title:titleVal,
    creator:creator.value,code:code-display.value,
    price:+price.value||0,shop:shop.value||"ä¸æ˜",
    location:location.value||"æœªå®š",
    condition:condition.value,
    date:date.value||new Date().toISOString().slice(0,10),
    img:document.getElementById('img-url').value
  };

  items.unshift(item);
  if(await syncToCloud()){
    resetForm(); render();
  }
}

/* ---------- UI ---------- */
function resetForm(){
  document.querySelectorAll('.form-grid input').forEach(i=>i.value="");
  edit-index.value=-1;
}

function render(){
  const list=document.getElementById('list');
  list.innerHTML="";
  items.forEach((i)=>{
    const div=document.createElement('div');
    div.className='item-card';
    div.innerHTML=`
      <img class="item-img" src="${i.img||'https://via.placeholder.com/80'}">
      <div class="item-main">
        <span class="tag" style="background:#3498db">${i.type}</span>
        <div><b>${i.title}</b></div>
        <div style="font-size:.8em;color:#666">${i.creator}</div>
      </div>
      <div>Â¥${i.price.toLocaleString()}</div>`;
    list.appendChild(div);
  });
}
</script>
</body>
</html>

